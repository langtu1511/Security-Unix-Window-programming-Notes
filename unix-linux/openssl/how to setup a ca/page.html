<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>How To Setup a CA</title>
</head><body><b><div style="text-align: center"><span style="font-size: 16pt"><br/>
</span></div></b><b><div style="text-align: center"><span style="font-size: 16pt">&nbsp;How To Setup a CA</span></div></b><br/>
<br/>
&nbsp;<a href="http://pages.cs.wisc.edu/~alderman/ca_chain_directions/staff_ca_chain_setup_notes.html">Original Version</a>&nbsp;by Ian Alderman<br/>
Updated by Zach Miller<br/>
REF: <a href="http://pages.cs.wisc.edu/~zmiller/ca-howto/">http://pages.cs.wisc.edu/~zmiller/ca-howto/</a><br/>
<br/>
<b><span style="font-size: 12pt">Introduction </span></b><br/>
<br/>
You can set up a Certificate Authority (CA) in multiple different ways. Our first pass here will be to set up a very simple, one-level CA for use with the SSL authentication method in Condor. Building on this knowledge, we will then set up a multi-level CA that could be used for the GSI authentication method in Condor (and other software that uses GSI). <br/>
<br/>
Our goal was to establish a multi-level CA. The difference between a multi-level CA and a single-level CA is that in a single-level CA, the root key is also the signing key for host and user certificates. We wanted to establish a root key which we could use to sign (and revoke if necessary) several signing keys which will be used for different purposes. So, if a local PKI is represented a tree where nodes are keys and edges are certificates, a single-level tree is height two and has just one non-leaf node, while our tree is height three and has a single root node, and several second level nodes. We will use the <a href="http://www.openssl.org/">OpenSSL</a>&nbsp;command line tool for most of this process. <br/>
<br/>
<b><span style="font-size: 12pt">Customize the configuration file for easy data entry </span></b><br/>
<br/>
While this step isn't strictly necessary for the following process, doing it makes subsequent steps a bit easier, and increases the chances of getting things right, and consistent. You could start with a copy of the default <a href="http://cvs.openssl.org/getfile?f=openssl/apps/openssl.cnf">openssl.cnf</a>&nbsp;file, and modify the defaults to suit your installation. Later on, you'll have to make other changes, so you may just want to get them all at once. Here's our <a href="openssl.cnf">customized openssl.cnf</a>. To see what we've changed scroll to the section labeled [ req_distinguished_name ] and examine the lines with the suffix _default. For example, our altered section reads as follows: [ req_distinguished_name ] countryName = Country Name (2 letter code) countryName_default = US countryName_min = 2 countryName_max = 2 stateOrProvinceName = State or Province Name (full name) stateOrProvinceName_default = Wisconsin localityName = Locality Name (eg, city) localityName_default = Madison 0.organizationName = Organization Name (eg, company) 0.organizationName_default = University of Wisconsin -- Madison 1.organizationName = Second Organization Name (eg, company) 1.organizationName_default = Computer Sciences Department organizationalUnitName = Organizational Unit Name (eg, section) organizationalUnitName_default = Condor Project commonName = Common Name (eg, YOUR name) commonName_max = 64 emailAddress = Email Address emailAddress_max = 40 &nbsp;<hr/>&nbsp;A Single-level CA Create the CA root key and self-signed certificate Create the keypair: <br/>
&nbsp;<b>openssl genrsa -des3 -out root-ca.key 1024</b>&nbsp; Generating RSA private key, 1024 bit long modulus ..............++++++ ..........++++++ e is 65537 (0x10001) Enter pass phrase for root-ca.key: Verifying - Enter pass phrase for root-ca.key: &nbsp;<br/>
You will be asked for a password which will be the CA password, and then you'll be asked for that password again. The output of this command, the file <b>root-ca.key</b>, contains an RSA keypair which is encryped using the password you supply. So, for someone to use this key to create new certificates (either host or client), they'll need BOTH this file and the password.<br/>
&nbsp;Use the key to sign itself: <br/>
&nbsp;<b>openssl req -new -x509 -days 3650 -key root-ca.key -out root-ca.crt -config openssl.cnf</b>&nbsp; Enter pass phrase for root-ca.key: You are about to be asked to enter information that will be incorporated into your certificate request. What you are about to enter is what is called a Distinguished Name or a DN. There are quite a few fields but you can leave some blank For some fields there will be a default value, If you enter '.', the field will be left blank. ----- Country Name (2 letter code) [US]: State or Province Name (full name) [Wisconsin]: Locality Name (eg, city) [Madison]: Organization Name (eg, company) [University of Wisconsin -- Madison]: Second Organization Name (eg, company) [Computer Sciences Department]: Organizational Unit Name (eg, section) [Condor Project]: Common Name (eg, YOUR name) []:ROOT CA Email Address []: &nbsp;<br/>
This reads, "create a new, self-signed X.509 certificate valid for ten years, for the keypair in the file root-ca.key, and place the output in the file root-ca.crt." <br/>
You will be prompted to input identifying information for the certificate. It's important not to use single quotes in the responses due to a quirk in the Globus implementation: for example don't use a Common Name such as "<b>Alice's CA</b>". If you have customized the configuration file as suggested above, the defaults you specified there will make this step easier. The openssl req command recognizes that the request is for a self signed certificate, and automatically applies suitable options, such as setting the "CA:TRUE" bit.<br/>
&nbsp;<br/>
&nbsp;Don't use an email address. This avoids <a href="http://www-unix.globus.org/mail_archive/discuss/2004/01/msg00354.html">this interaction bug</a>&nbsp;in signing policy files. <br/>
&nbsp;Now, let's take a look at the certificate we generated: <br/>
&nbsp;<b>openssl x509 -noout -text -in root-ca.crt</b>&nbsp;<br/>
&nbsp;Finally, we need to put these certificates and keys into a directory where our config file can find them for future use. Here is a <a href="mk_new_ca_dir.pl">perl script</a>&nbsp;to create the directory heirarchy you will need. <br/>
&nbsp;Run it like this: <br/>
&nbsp;<b>perl mk_new_ca_dir.pl CondorSigningCA1<br/>
</b><b>mv root-ca.crt CondorSigningCA1/signing-ca-1.crt<br/>
mv root-ca.key CondorSigningCA1/signing-ca-1.key<br/>
</b>&nbsp;Using the Root CA to Sign Certificates Users User certificates have the user name as the CN, and their email address. OpenSSL allows you to create a key and a certificate signing request in one step: <br/>
&nbsp;<b>openssl req -newkey rsa:1024 -keyout zmiller.key -config openssl.cnf -out zmiller.req</b>&nbsp; Generating a 1024 bit RSA private key ....................++++++ ..++++++ writing new private key to 'zmiller.key' Enter PEM pass phrase: Verifying - Enter PEM pass phrase: ----- You are about to be asked to enter information that will be incorporated into your certificate request. What you are about to enter is what is called a Distinguished Name or a DN. There are quite a few fields but you can leave some blank For some fields there will be a default value, If you enter '.', the field will be left blank. ----- Country Name (2 letter code) [US]: State or Province Name (full name) [Wisconsin]: Locality Name (eg, city) [Madison]: Organization Name (eg, company) [University of Wisconsin -- Madison]: Second Organization Name (eg, company) [Computer Sciences Department]: Organizational Unit Name (eg, section) [Condor Project]: Common Name (eg, YOUR name) []:Zach Miller Email Address []:zmiller@cs.wisc.edu &nbsp;<br/>
&nbsp;Then sign it, remembering the signing key password: <br/>
&nbsp;<b>openssl ca -config openssl.cnf -out zmiller.crt -infiles zmiller.req </b>&nbsp; Using configuration from openssl.cnf Enter pass phrase for ./CondorSigningCA1/signing-ca-1.key: Check that the request matches the signature Signature ok Certificate Details: Serial Number: 1 (0x1) Validity Not Before: Apr 29 15:15:17 2008 GMT Not After : Apr 29 15:15:17 2009 GMT Subject: countryName = US stateOrProvinceName = Wisconsin localityName = Madison organizationName = University of Wisconsin -- Madison organizationName = Computer Sciences Department organizationalUnitName = Condor Project commonName = Zach Miller X509v3 extensions: X509v3 Basic Constraints: CA:FALSE Netscape Comment: OpenSSL Generated Certificate X509v3 Subject Key Identifier: 58:51:B5:B5:C4:8B:74:A5:43:22:5B:1B:27:F6:7E:F3:A8:60:07:32 X509v3 Authority Key Identifier: keyid:95:AE:11:9A:6C:3A:07:F5:6C:4A:CB:A8:5A:77:15:C5:02:30:08:37 DirName:/C=US/ST=Wisconsin/L=Madison/O=University of Wisconsin -- Madison/O=Computer Sciences Department/OU=Condor Project/CN=ROOT CA serial:ED:11:AB:0C:05:2F:6B:84 Certificate is to be certified until Apr 29 15:15:17 2009 GMT (365 days) Sign the certificate? [y/n]:y 1 out of 1 certificate requests certified, commit? [y/n]y Write out database with 1 new entries Data Base Updated &nbsp;Hosts Host certificates have the hostname as the CN (this is required for Globus), and the email address of the requester.<br/>
&nbsp;<b>openssl req -newkey rsa:1024 -keyout host_omega.key -nodes -config openssl.cnf -out host_omega.req </b>&nbsp; Generating a 1024 bit RSA private key ..............++++++ .++++++ writing new private key to 'host_omega.key' ----- You are about to be asked to enter information that will be incorporated into your certificate request. What you are about to enter is what is called a Distinguished Name or a DN. There are quite a few fields but you can leave some blank For some fields there will be a default value, If you enter '.', the field will be left blank. ----- Country Name (2 letter code) [US]: State or Province Name (full name) [Wisconsin]: Locality Name (eg, city) [Madison]: Organization Name (eg, company) [University of Wisconsin -- Madison]: Second Organization Name (eg, company) [Computer Sciences Department]: Organizational Unit Name (eg, section) [Condor Project]: Common Name (eg, YOUR name) []:omega.cs.wisc.edu Email Address []:zmiller@cs.wisc.edu &nbsp;<br/>
&nbsp;<b>openssl ca -config openssl.cnf -out host_omega.crt -infiles host_omega.req</b>&nbsp; Using configuration from openssl.cnf Enter pass phrase for ./CondorSigningCA1/signing-ca-1.key: DEBUG[load_index]: unique_subject = "yes" Check that the request matches the signature Signature ok Certificate Details: Serial Number: 2 (0x2) Validity Not Before: Apr 29 15:18:20 2008 GMT Not After : Apr 29 15:18:20 2009 GMT Subject: countryName = US stateOrProvinceName = Wisconsin localityName = Madison organizationName = University of Wisconsin -- Madison organizationName = Computer Sciences Department organizationalUnitName = Condor Project commonName = omega.cs.wisc.edu emailAddress = zmiller@cs.wisc.edu X509v3 extensions: X509v3 Basic Constraints: CA:FALSE Netscape Comment: OpenSSL Generated Certificate X509v3 Subject Key Identifier: 56:B9:56:A2:B1:BB:7B:61:0E:21:71:A1:BC:3E:CD:E2:79:DD:F1:75 X509v3 Authority Key Identifier: keyid:95:AE:11:9A:6C:3A:07:F5:6C:4A:CB:A8:5A:77:15:C5:02:30:08:37 DirName:/C=US/ST=Wisconsin/L=Madison/O=University of Wisconsin -- Madison/O=Computer Sciences Department/OU=Condor Project/CN=ROOT CA serial:ED:11:AB:0C:05:2F:6B:84 Certificate is to be certified until Apr 29 15:18:20 2009 GMT (365 days) Sign the certificate? [y/n]:y 1 out of 1 certificate requests certified, commit? [y/n]y Write out database with 1 new entries Data Base Updated &nbsp;<hr/>&nbsp;Multi-level CAs (If you just completed the single-level CA exercise above, you'll need to 'rm -rf CondorSigningCA1' before continuing) <br/>
&nbsp;Good Policy <br/>
For now we ignore the certificate revocation issues. <br/>
&nbsp;The key size must be determined: we used 1024 bits. <br/>
&nbsp;Two periods must be determined: the validity period of the root certificate, and the validity period of the signing certificate. For the first pass at the CA, we used twenty years (7300 days) for the former, and three years (1095 days) for the latter. Ten years (3650 days) may be more reasonable for the root key. <br/>
&nbsp;The security of the root key is critical, because it is so long lived, and because it can be used to revoke the signing key if necessary. So, we established the policy that the root key is never stored or decrypted on a machine which has an active network connection. I turn off my laptop's wireless connection, create the key, create a cd with just the key on it, burn the cd, and remove the key from the laptop. In the openssl directory, the key is a link to the cd filesystem. When I need to create a signing key, I turn off the network connection, put in the CD, create the key, eject the CD, then turn on the network connection. <br/>
&nbsp;There are two people who have copies of the root key CD and know the password. <br/>
&nbsp;<br/>
&nbsp;We will not be disconnecting from the network or burning CDs for this HOWTO. <br/>
&nbsp;Create the CA root key and self-signed certificate Create the keypair: <br/>
&nbsp;<b>openssl genrsa -des3 -out root-ca.key 1024</b>&nbsp; Generating RSA private key, 1024 bit long modulus ...++++++ ................++++++ e is 65537 (0x10001) Enter pass phrase for root-ca.key: Verifying - Enter pass phrase for root-ca.key: &nbsp;<br/>
You will be asked for a password which will be the CA password, and then you'll be asked for that password again. The output of this command, the file <b>root-ca.key</b>, contains an RSA keypair which is encryped using the password you supply. So, for someone to use this key to create new certificates (either host or client), they'll need both this file and the password.<br/>
&nbsp;Use the key to sign itself: <br/>
&nbsp;<b>openssl req -new -x509 -days 3650 -key root-ca.key -out root-ca.crt -config openssl.cnf</b>&nbsp; Enter pass phrase for root-ca.key: You are about to be asked to enter information that will be incorporated into your certificate request. What you are about to enter is what is called a Distinguished Name or a DN. There are quite a few fields but you can leave some blank For some fields there will be a default value, If you enter '.', the field will be left blank. ----- Country Name (2 letter code) [US]: State or Province Name (full name) [Wisconsin]: Locality Name (eg, city) [Madison]: Organization Name (eg, company) [University of Wisconsin -- Madison]: Second Organization Name (eg, company) [Computer Sciences Department]: Organizational Unit Name (eg, section) [Condor Project]: Common Name (eg, YOUR name) []:ROOT CA Email Address []: &nbsp;<br/>
This reads, "create a new, self-signed X.509 certificate valid for ten years, for the keypair in the file root-ca.key, and place the output in the file root-ca.crt." <br/>
You will be prompted to input identifying information for the certificate. It's important not to use single quotes in the responses due to a quirk in the Globus implementation: for example don't use a Common Name such as "<b>Alice's CA</b>". If you have customized the configuration file as suggested above, the defaults you specified there will make this step easier. The openssl req command recognizes that the request is for a self signed certificate, and automatically applies suitable options, such as setting the "CA:TRUE" bit.<br/>
&nbsp;<br/>
&nbsp;Don't use an email address. This avoids <a href="http://www-unix.globus.org/mail_archive/discuss/2004/01/msg00354.html">this interaction bug</a>&nbsp;in signing policy files. Preparing a directory structure for the root CA In order to make use of two different CAs (<i>i.e.</i>, our root CA in addition to our signing CA), OpenSSL needs either two openssl.cnf files, or one with multiple CA sections. We'll take the latter approach. This requires a directory heirarchy to store the different signing keys. (Note that the directory contents must reflect the settings in the openssl.cnf file you just downloaded.) You probably already downloaded it, but if not here's our <a href="openssl.cnf">modified replacement</a>. You'll also want <a href="mk_new_ca_dir.pl">this perl script</a>, which performs the following steps: <br/>
&nbsp;<ul><li style="list-style-type: none">Create a directory for the bookkeeping files to reside. Create a directory to store information about the certificates created. Create and initialize a file that stores a count of the number of certificates created. Create and initialize a file that stores a random seed. </li>
<li></li>
<li></li>
<li></li>
</ul>
In other guides that describe how to sign certificates, these steps are performed by the openssl script sign.sh. <br/>
&nbsp;Run the perl script and move the root-ca files into the new directory: <b>&nbsp;<br/>
</b><b>perl mk_new_ca_dir.pl <br/>
mv root-ca.crt CondorRootCA <br/>
</b><b>mv root-ca.key CondorRootCA </b>&nbsp;<br/>
&nbsp;Creating the signing certificates Creating the signing certificates is nearly as easy. The certificates must be created with the "CA:TRUE" bit set, as noted above. First, we create the keypair for the signing key. This is similar to the step used to create the keypair for the root key, above. <br/>
&nbsp;<b>openssl genrsa -des3 -out signing-ca-1.key 1024</b>&nbsp; Generating RSA private key, 1024 bit long modulus ..........++++++ ..................................++++++ e is 65537 (0x10001) Enter pass phrase for signing-ca-1.key: Verifying - Enter pass phrase for signing-ca-1.key: &nbsp;<br/>
&nbsp;Now, instead of creating the request and signing it with the private key just created, as is done above, here we create a request in one step, and then sign it using the root key in another. First, we create the request. (<a href="http://www-unix.globus.org/mail_archive/discuss/2004/01/msg00354.html">Don't use</a>&nbsp;an email address here either.) <br/>
<b>openssl req -new -days 1095 -key signing-ca-1.key -out signing-ca-1.csr -config openssl.cnf</b>&nbsp; Enter pass phrase for signing-ca-1.key: You are about to be asked to enter information that will be incorporated into your certificate request. What you are about to enter is what is called a Distinguished Name or a DN. There are quite a few fields but you can leave some blank For some fields there will be a default value, If you enter '.', the field will be left blank. ----- Country Name (2 letter code) [US]: State or Province Name (full name) [Wisconsin]: Locality Name (eg, city) [Madison]: Organization Name (eg, company) [University of Wisconsin -- Madison]: Second Organization Name (eg, company) [Computer Sciences Department]: Organizational Unit Name (eg, section) [Condor Project]: Common Name (eg, YOUR name) []:SIGNING CA 1 Email Address []: &nbsp;<br/>
&nbsp;Then, we sign the request, using the "-name" argument to specify the section in the altered openssl.cnf file: <br/>
&nbsp;<b>openssl ca -config openssl.cnf -name CA_root -extensions v3_ca -out signing-ca-1.crt -infiles signing-ca-1.csr</b>&nbsp;Preparing a directory structure for the signing CA Now, we can create a directory structure for the signing key, using the <a href="mk_new_ca_dir.pl">same perl script</a>&nbsp;we used to create the root CA directory structure. This time, we give an argument to the script to tell it the name of the directory, corresponding to the directory name in the openssl.cnf file. <br/>
&nbsp;Run the perl script and copy the signing key files into new directory: <b>&nbsp;<br/>
</b><b>perl mk_new_ca_dir.pl CondorSigningCA1 <br/>
mv signing-ca-1.crt CondorSigningCA1 <br/>
</b><b>mv signing-ca-1.key CondorSigningCA1 </b>&nbsp;Generating keys, signing requests, and certificates (Same as above) Users User certificates have the user name as the CN, and their email address. OpenSSL allows you to create a key and a certificate signing request in one step: <br/>
&nbsp;<b>openssl req -newkey rsa:1024 -keyout zmiller.key -config openssl.cnf -out zmiller.req</b>&nbsp;<br/>
&nbsp;Then sign it, remembering the signing key password: <br/>
&nbsp;<b>openssl ca -config openssl.cnf -out zmiller.crt -infiles zmiller.req </b>&nbsp;Hosts Host certificates have the hostname as the CN (this is required for Globus), and the email address of the requester.<br/>
&nbsp;<b>openssl req -newkey rsa:1024 -keyout host_omega.key -nodes -config openssl.cnf -out host_omega.req </b>&nbsp;<br/>
&nbsp;<b>openssl ca -config openssl.cnf -out host_omega.crt -infiles host_omega.req</b>&nbsp; Extras &nbsp;<br/>
&nbsp;There's a <a href="mk_certs.pl">perl script</a>&nbsp;for generating certs from an <a href="real_input.txt">input</a>&nbsp;file. <br/>
&nbsp;Check out <a href="http://www.globus.org/">Globus'</a>&nbsp;<a href="http://toolkit.globus.org/toolkit/security/">GSI</a>. <br/>
&nbsp;Other handy OpenSSL commmand line tools: <br/>
&nbsp;<ul><li>To get a hash:</li>
<li><b>openssl x509 -noout -hash -in host.crt</b>&nbsp;To get a subject:</li>
<li><b>openssl x509 -noout -subject -in host.crt</b>&nbsp;To see the whole cert:</li>
<li><b>openssl x509 -noout -text -in host.crt</b>&nbsp;</li>
<li></li>
<li></li>
</ul>
Condor Configuration See the manual, <a href="http://www.cs.wisc.edu/condor/manual/v7.0/3_6Security.html#SECTION00463200000000000000">SSL Configuration</a>&nbsp;<br/>
&nbsp;Generally, you'll want to use a single-level CA to setup easy SSL host-to-host authentication. You can share a single cert for all of your hosts and Condor daemons, or you can have one certificate per host. (You could in theory have one certificate per daemon per host if you wanted, but that's probably overkill). If you are going to use SSL authentication in Condor, you'll also want to read <a href="http://www.cs.wisc.edu/condor/manual/v8.0/3_6Security.html">the manual section on security</a>&nbsp;to learn how to enable it. <br/>
&nbsp;Quick Example (Condor Version 7.0.1): <br/>
&nbsp;If you generated just a single-level CA here's how you would configure Condor to use those certificates for daemon-to-daemon communication. Specify full paths to the crt and key files. Make sure the files are owned and readable <b>only</b>&nbsp;by the condor user. <br/>
&nbsp; SEC_DAEMON_AUTHENTICATION = REQUIRED<br/>
SEC_DAEMON_AUTHENTICATION_METHODS = SSL<br/>
ALLOW_DAEMON = ssl@unmappeduser<br/>
&nbsp;<br/>
AUTH_SSL_CLIENT_CAFILE = root-ca.crt<br/>
AUTH_SSL_CLIENT_CERTFILE = host_omega.crt<br/>
AUTH_SSL_CLIENT_KEYFILE = host_omega.key<br/>
&nbsp;<br/>
AUTH_SSL_SERVER_CAFILE = root-ca.crt<br/>
AUTH_SSL_SERVER_CERTFILE = host_omega.crt<br/>
AUTH_SSL_SERVER_KEYFILE = host_omega.key<br/>
&nbsp;</body></html>